.controller
%div{"data-role" => "header"}
  %h1 New Search
%div{"data-role" => "content", :role => "main"}
  = form_tag(mobile_search_index_path, method: :post, remote: true, id: "mobile_search_form") do
    = render partial: "location"
    = render partial: "day_time"
    = render partial: "group"
    = render partial: "open_closed"
    = render partial: "special_focus"
    = render partial: "access"
    = render partial: "language"
    - search_text = "Show #{pluralize(@options.count, "meetings")}"
    = button_to search_text, mobile_search_index_path, {:method => :post, :class => "meeting-search-button", "data-role" => "button", "data-icon" => "arrow-r", "data-iconpos" => "right", "rel" => "external"}
  %button{ "class" => "meeting-search-hot-button", "data-role" => "button", "data-icon" => "arrow-r", "data-iconpos" => "right", "id" => "one-time" }
    = "Quick Search (Upcoming Nearby)"
= render "footer"

:javascript
  history.pushState("new_search", "New Search", "new");

  function main(){

    var submitButton = $('[type="submit"]');
    $(".city-text, .group-text").on("click", function() {
      if ($(this).val() == "(Optional search text)"){
          $(this).val("")
        }
    });

    $('.group-text').on("blur", function(){
      if ( $(this).val().length > 0 ){
        if ( $('#group_name').parent().css('display') !== 'none' ){
          $('#group_name').parent().toggle('hidden');
        }
      }
    });

    $('.city-text').on("blur", function(){
      if ( $(this).val().length > 0 ){
        if( $('.here-box').parent().css('display') !== 'none' ){
          $('.here-box').parent().toggle('hidden');
        }
        if( $('#city-button').parent().css('display') !== 'none' ){
          $('#city-button').parent().toggle('hidden');
        }
      }
    });

    $(".meeting-search-hot-button").on("click", function(){
      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          "lat": position.coords.latitude,
          "lng": position.coords.longitude
        };

        var createUrl = '#{here_and_now_mobile_search_index_path(
          lat: "__LAT__", lng: "__LNG__", format: :js)}';
        createUrl = createUrl.replace("__LAT__", pos["lat"]).replace("__LNG__", pos["lng"]);

        $.getScript(createUrl);
        return false;
      });
      } else {
        alert("Geolocation cancelled or unsupported");
        return false;
       }
    });

    $('#city').change(function(){
      if( $('#city').val() !== "any" ){
        if( $('.here-box').parent().css('display') !== 'none' ){
          $('.here-box').parent().toggle('hidden');
        }
        if( $('#city_text').parent().css('display') !== 'none' ){
          $('#city_text').parent().toggle('hidden');
        }
      } else {
        if( $('.here-box').parent().css('display') === 'none' ){
          $('.here-box').parent().toggle('hidden');
        }
        if( $('#city_text').parent().css('display') === 'none' ){
          $('#city_text').parent().toggle('hidden');
        }
      }
    });

    $(".here-box").on("click", function(){
      submitButton.button('disable'); //wait for lat and lng
      $('#city-button').toggle('hidden');
      $('#city_text').parent().toggle('hidden');

      if (navigator.geolocation) {
        navigator.geolocation.getCurrentPosition(function(position) {
        var pos = {
          lat: position.coords.latitude,
          lng: position.coords.longitude
        };
        $(".main-lat").val(pos["lat"]);
        $(".main-lng").val(pos["lng"]);
        console.log("lat is: " + pos["lat"] + " lng is: " + pos["lng"]);
        submitButton.button('enable');
      });
      } else {
        submitButton.button('enable');
      }
    }); //here-box on click (proximity without here and now)


    function MenuController(args){
      this.menuElements = [];
      $('.controller').attr('data', this);
    }

    MenuController.prototype.updateSelection = function(data) {
      var optionsUrl = '#{get_new_options_mobile_search_index_path(format: :json)}';
      // var data = { source : value };
      // optionsUrl = optionsUrl.replace(__PARAMS__, data);

      $.ajax({
        url: optionsUrl,
        data: data,
        success: function(data){
          this.notifyChange(data);
        }.bind(this)
      });//.done(this.notifyChange(data)).bind(this);
    }

    MenuController.prototype.notifyChange = function(data){
      console.log("in notify change");
      var sendData = {};
      _.each(this.menuElements, function(element){

        element.processUpdate(data);
      }.bind(this));

    }

    MenuController.prototype.registerElement = function(element){
      this.menuElements.push(element);
    }

    function MenuElement(args){
      this.elementName = args["elementName"];
      this.hook = $('#' + this.elementName);
      this.setListener();
      this.controller = args["controller"];
      this.controller.registerElement(this);
    }

    MenuElement.prototype.processUpdate = function(data){
      if ( data.source === this.elementName ){
        return;
      }

      var selections = data.options[this.elementName];
      var optionsSelector = $(this.hook.find('option'));

      _.each(optionsSelector, function(option){
        if( selections.indexOf( $(option).val() ) < 0 ){
          $(option).attr('disabled', 'disabled');
        }
      });
    };

    MenuElement.prototype.setDefault = function(defaultSelection){
      this.hook.val(defaultSelection);
      this.hook.selectmenu('refresh');
    };

    MenuElement.prototype.setListener = function(){
      this.hook.change(function() {
        var data = { 
          "source"    : this.elementName,
          "selection" : this.hook.val()
        };

        this.controller.updateSelection(data);
      }.bind(this));
    };

    MenuElement.prototype.currentSelection = function(){
      return this.hook.val();
    }.bind(this);

    menuController = new MenuController();
    var menuInitializer = {
      'elementName' : 'day',
      'controller' : menuController
    }
    daysMenu = new MenuElement(menuInitializer);

    menuInitializer['elementName'] = "city";
    cityMenu = new MenuElement(menuInitializer);









  }

  $(document).ready( main() );
